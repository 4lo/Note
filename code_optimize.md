# 代码优化

代码优化器的任务:

将前端产生的中间代码转化为等价的目标代码

生成高质量的目标代码而对程序代码进行时空效率优化,使最终生成的目标代码运行时间更短,占用空间更小.



代码优化器的要求:

1. 等价变换
2. 提高目标代码的执行速度
3. 减少目标代码占用的空间



#### 优化的主要种类:

- 基本块优化

  常数合并,常数传播,冗余子表达式的删除,死代码的删除

- 循环优化

  循环展开,频度削弱(代码外提),归纳变量的消除,强度削弱

- 全局优化

  在非线性的程序段上,进行优化

  全局流程分析

- 窥孔优化

  在目标代码进行局部改造的一种有效的技术

### 基本块优化:

**常数合并**:

*局部优化技术*,有数组下标的时候应注意

```
a[n] = 6
a[m] = 3
b = 3 * a[n]
```

要注意m和n的值相不相等

用值代替能在编译时算出的变量



不能将结合律与交换律用于浮点表达式(浮点数精度有限,这两个率不恒真)



**删除冗余的公共表达式:**

```
a = b + c
b = a - d
c = b + c
d = a - d
```

可以变化为



**删除死代码:**

不被引用的变量

分支条件不可达



**削弱计算强度:**



**临时变量改名:**



**交换语句位置:**

互不依赖的两个语句,互换位置会改变寄存器的使用方式



### 循环优化:

##### 循环展开

把循环结构体变成简单的赋值语句

```
for (i = 0; i < 10; i++)
	x[i] = 0;
```

展开为

```
x[0] = 0;
.
.
.
x[9] = 0;
```

##### 频度削弱/代码外提:

```
while (i < limit - 2){
  
}
```

变为

```
a = limit - 2;
while (i < a){
  
}
```

##### 归纳变量的删除:

彼此之间同步递归

##### 削弱计算强度:

计算强度: ** > * > +



### 窥孔优化:

目标代码局部改进的简单有效技术

##### 冗余指令删除:

##### 死代码的删除

控制流中不可达

```
if false:
	xxxx
```

##### 控制流优化:

连续跳转

```
goto L1

L1:goto L2
```

应当直接

```
goto L2
```

##### 代数化简:

```
x = x + 0 -> x
x = x * 1 -> x
```

##### 充分利用机器特点:

比如更专门的硬指令



### Dag 在代码生成中的应用

###### Dag 不同于流图

对基本块进行优化

选择恰当执行顺序,优化寄存器使用

自动检测出公共子表达式

叶节点的标识符在块外计算,在块内被引用

定值被块外引用